#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$SCRIPT_DIR/lib"

# shellcheck source=/dev/null
source "$LIB_DIR/utils.sh"
source "$LIB_DIR/os_detect.sh"
source "$LIB_DIR/packages.sh"
source "$LIB_DIR/languages.sh"
source "$LIB_DIR/latex_gen.sh"
source "$LIB_DIR/build.sh"

usage() {
  cat <<EOF
Usage: $(basename "$0") <folder_path> <file_extension>

Example:
  $(basename "$0") /path/to/project cs
EOF
}

main() {
  if [[ $# -ne 2 ]]; then
    usage
    exit 1
  fi

  local folder_path="$1"
  local file_ext="$2"

  require_command find
  require_command sed

  if [[ ! -d "$folder_path" ]]; then
    die "Folder does not exist: $folder_path"
  fi

  local distro
  distro="$(detect_distro)"
  echo "Detected distro: $distro"

  # Install deps (minted needs pygments + -shell-escape build)
  install_required_packages "$distro"

  local language
  language="$(language_for_ext "$file_ext")"
  if [[ -z "$language" ]]; then
    die "Language for file extension '.$file_ext' is not defined."
  fi

  local output_tex="generated.tex"
  local output_pdf="output.pdf"

  generate_latex_file "$output_tex" "$folder_path" "$file_ext" "$language"
  build_pdf "$output_tex" "$output_pdf"
  cleanup_build_artifacts "$output_tex"

  echo "PDF generated as $output_pdf"
}

main "$@"

